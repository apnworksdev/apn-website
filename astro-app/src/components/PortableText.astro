---
import type { PortableTextBlock } from "@portabletext/types";

interface Props {
  content?: PortableTextBlock[];
  class?: string;
}

const { content, class: className } = Astro.props;

// Normalize content to always be an array
const contentArray = Array.isArray(content) ? content : content ? [content] : [];

if (contentArray.length === 0) {
  return null;
}
---

<div class={className ? `portable-text ${className}` : "portable-text"}>
  {contentArray.map((block: any) => {
    if (block._type !== "block") return null;
    
    const Tag = block.style === "normal" ? "p" : block.style || "p";
    
      const children = block.children?.map((child: any) => {
        if (child._type !== "span") return null;
        
        let text = child.text || "";
        let hasLink = false;
        let linkHref = "#";
        let isBold = false;
        let isItalic = false;
        
        if (child.marks && child.marks.length > 0) {
          child.marks.forEach((mark: string) => {
            // Check for decorators (strong, em)
            if (mark === "strong") {
              isBold = true;
            } else if (mark === "em") {
              isItalic = true;
            } else {
              // Check for annotations (links)
              const markDef = block.markDefs?.find((def: any) => def._key === mark);
              if (markDef?._type === "link") {
                hasLink = true;
                linkHref = markDef.href || "#";
              }
            }
          });
        }
        
        if (hasLink) {
          return { type: "link", href: linkHref, text, isBold, isItalic };
        }
        
        return { type: "text", text, isBold, isItalic };
      }).filter(Boolean) || [];
    
      return (
        <Tag>
          {children.map((child: any) => {
            if (child.type === "link") {
              const linkContent = (
                <>
                  {child.isBold && child.isItalic ? (
                    <strong><em>{child.text}</em></strong>
                  ) : child.isBold ? (
                    <strong>{child.text}</strong>
                  ) : child.isItalic ? (
                    <em>{child.text}</em>
                  ) : (
                    child.text
                  )}
                </>
              );
              return <a href={child.href}>{linkContent}</a>;
            }
            // Determine class based on formatting
            const classes: string[] = [];
            if (child.isBold || child.isItalic) {
              classes.push("small-caps small-caps-span");
            }
            if (child.isBold) {
              classes.push("small-caps-span-bold");
            } else if (child.isItalic) {
              classes.push("small-caps-span-italic");
            } else {
              classes.push("regular-span");
            }

            const formattedContent = (
              <>
                {child.isBold ? (
                  <strong>{child.text}</strong>
                ) : (
                  child.text
                )}
              </>
            );

            return (
              <span class={classes.join(" ")}>{formattedContent}</span>
            );
          })}
        </Tag>
      );
  })}
</div>